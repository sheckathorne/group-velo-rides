{% extends "base.html" %}

{% load group_velo_clubs_tags %}
{% load to_sqid from group_velo_data_tags %}
{% load humanize %}

{% block title %}
  GroupVelo | My Clubs
{% endblock title %}
{% block content %}
  {% if club_list %}
    {% include 'clubs/modals/request_club_verification/_blank.html' %}
    <div class="flex flex-col gap-6">
      <div class="bg-gradient-to-r from-purple-700 to-pink-600 text-white p-6 rounded-lg shadow-md">
        <h1 class="text-3xl font-bold tracking-tight">My Clubs</h1>
        <p class="mt-2 opacity-90">Manage your cycling club memberships and activities</p>
      </div>
      <div class="flex flex-col gap-4">
        {% for mem in club_list %}
          {% with membership=mem.membership available_ride_count=mem.available_ride_count registered_ride_count=mem.registered_ride_count enable_rides_button=mem.enable_rides_button %}
            <div class="bg-white rounded-lg overflow-hidden shadow-md border-l-4 border-emerald-600">
              <div class="p-4 sm:p-5">
                <div class="flex flex-col sm:flex-row gap-4">
                  <div class="flex items-start gap-4 flex-1">
                    <div class="h-14 w-14 flex-shrink-0 rounded-full flex items-center justify-center bg-emerald-100 text-emerald-600 font-bold text-xl">
                      Mo
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="flex flex-col sm:flex-row sm:items-center gap-2 justify-between">
                        <h3 class="text-xl font-bold truncate">{{ membership.club.name }}</h3>
                        <div class="flex flex-wrap gap-2">
                          <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">Premium</span>
                          <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-600 text-white">Admin</span>
                          <span class="text-xs text-gray-500">Expires: {{ membership.membership_expires|date }}</span>
                        </div>
                      </div>
                      <p class="text-gray-600 text-sm mt-1 line-clamp-2">{{ membership.club.description|safe }}</p>
                      <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm mt-2">
                        <div class="flex items-center gap-1 text-gray-600">
                          <svg xmlns="http://www.w3.org/2000/svg"
                               width="24"
                               height="24"
                               viewBox="0 0 24 24"
                               fill="none"
                               stroke="currentColor"
                               stroke-width="2"
                               stroke-linecap="round"
                               stroke-linejoin="round"
                               class="lucide lucide-users h-4 w-4">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                            <circle cx="9" cy="7" r="4" />
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                          </svg>
                          <span>{{ membership.club.active_and_current_member_count|intcomma }} member{{ membership.club.active_and_current_member_count|pluralize }}</span>
                        </div>
                        <div class="flex items-center gap-1 text-gray-600">
                          <svg xmlns="http://www.w3.org/2000/svg"
                               width="24"
                               height="24"
                               viewBox="0 0 24 24"
                               fill="none"
                               stroke="currentColor"
                               stroke-width="2"
                               stroke-linecap="round"
                               stroke-linejoin="round"
                               class="lucide lucide-user-cog h-4 w-4">
                            <circle cx="18" cy="15" r="3" />
                            <circle cx="9" cy="7" r="4" />
                            <path d="M10 15H6a4 4 0 0 0-4 4v2" />
                            <path d="m21.7 16.4-.9-.3" />
                            <path d="m15.2 13.9-.9-.3" />
                            <path d="m16.6 18.7.3-.9" />
                            <path d="m19.1 12.2.3-.9" />
                            <path d="m19.6 18.7-.4-1" />
                            <path d="m16.8 12.3-.4-1" />
                            <path d="m14.3 16.6 1-.4" />
                            <path d="m20.7 13.8 1-.4" />
                          </svg>
                          <span class="mr-1">Admin{{ membership.club.club_admins|length|pluralize }}:</span>
                          {% with club_admins=membership.club.club_admins %}
                            <div class="flex flex-row">
                              <span class="text-sm">
                                {% for ad in club_admins %}
                                  {% if forloop.counter == 1 %}
                                    {{ ad.user.name }}
                                  {% else %}
                                    , {{ ad.user.name }}
                                  {% endif %}
                                {% endfor %}
                              </span>
                            </div>
                          {% endwith %}
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="flex flex-row sm:flex-col gap-2 mt-3 sm:mt-0 overflow-x-auto pb-1 sm:pb-0">
                    <button class="flex items-center justify-center gap-1 px-3 py-2 rounded-md whitespace-nowrap bg-emerald-600 hover:bg-emerald-700 text-white font-medium text-sm transition-colors">
                      <svg xmlns="http://www.w3.org/2000/svg"
                           width="24"
                           height="24"
                           viewBox="0 0 24 24"
                           fill="none"
                           stroke="currentColor"
                           stroke-width="2"
                           stroke-linecap="round"
                           stroke-linejoin="round"
                           class="lucide lucide-calendar-plus h-4 w-4">
                        <path d="M8 2v4" />
                        <path d="M16 2v4" />
                        <path d="M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8" />
                        <path d="M3 10h18" />
                        <path d="M16 19h6" />
                        <path d="M19 16v6" />
                      </svg>
                      <span>Create Ride</span>
                    </button>
                    <div class="flex gap-2">
                      <button class="flex items-center justify-center gap-1 px-3 py-2 rounded-md whitespace-nowrap bg-white border border-emerald-300 hover:bg-emerald-50 text-emerald-700 font-medium text-sm transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             width="24"
                             height="24"
                             viewBox="0 0 24 24"
                             fill="none"
                             stroke="currentColor"
                             stroke-width="2"
                             stroke-linecap="round"
                             stroke-linejoin="round"
                             class="lucide lucide-calendar h-4 w-4">
                          <path d="M8 2v4" />
                          <path d="M16 2v4" />
                          <rect width="18" height="18" x="3" y="4" rx="2" />
                          <path d="M3 10h18" />
                        </svg>
                        <span>Join Ride</span>
                      </button>
                      <button class="flex items-center justify-center gap-1 px-3 py-2 rounded-md whitespace-nowrap bg-white border border-emerald-300 hover:bg-emerald-50 text-emerald-700 font-medium text-sm transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             width="24"
                             height="24"
                             viewBox="0 0 24 24"
                             fill="none"
                             stroke="currentColor"
                             stroke-width="2"
                             stroke-linecap="round"
                             stroke-linejoin="round"
                             class="lucide lucide-calendar h-4 w-4">
                          <path d="M8 2v4" />
                          <path d="M16 2v4" />
                          <rect width="18" height="18" x="3" y="4" rx="2" />
                          <path d="M3 10h18" />
                        </svg>
                        <span>View Rides</span>
                      </button>
                    </div>
                    <div class="flex gap-2">
                      <button class="flex items-center justify-center gap-1 px-3 py-2 rounded-md whitespace-nowrap bg-white border border-emerald-300 hover:bg-emerald-50 text-emerald-700 font-medium text-sm transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             width="24"
                             height="24"
                             viewBox="0 0 24 24"
                             fill="none"
                             stroke="currentColor"
                             stroke-width="2"
                             stroke-linecap="round"
                             stroke-linejoin="round"
                             class="lucide lucide-users h-4 w-4">
                          <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                          <circle cx="9" cy="7" r="4" />
                          <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                          </path
                          <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                        </svg>
                        <span>Members</span>
                      </button>
                      <button class="flex items-center justify-center gap-1 px-3 py-2 rounded-md whitespace-nowrap bg-white border border-emerald-300 hover:bg-emerald-50 text-emerald-700 font-medium text-sm transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             width="24"
                             height="24"
                             viewBox="0 0 24 24"
                             fill="none"
                             stroke="currentColor"
                             stroke-width="2"
                             stroke-linecap="round"
                             stroke-linejoin="round"
                             class="lucide lucide-square-pen h-4 w-4">
                          <path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                          <path d="M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z" />
                        </svg>
                        <span>Edit</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="group">
              <h2 id="clubs-accordion-collapse-heading-{{ membership.club.id|to_sqid }}">
                <button type="button"
                        class="flex flex-row items-center justify-between w-full p-6 font-medium text-left text-gray-700 border-b-0{{ border_class }} dark:focus:ring-gray-800 dark:border-gray-800 dark:text-gray-300 hover:bg-blue-100 dark:hover:bg-gray-800">
                  <div class="flex flex-row items-center">
                    <img class="mx-auto w-16 object-contain"
                         src="{{ membership.club.get_logo }}"
                         alt="logo" />
                    <div class="flex flex-col">
                      <span class="pl-4">{{ membership.club.name }}
                        {% if membership.club.verified %}
                          {% include 'clubs/partials/_verified_badge.html' %}
                        {% endif %}
                      </span>
                      <span class="pl-4 text-gray-500 dark:text-gray-400 font-light text-xs">{{ membership.club.city }}, {{ membership.club.state }}</span>
                    </div>
                  </div>
                  <div class="flex flex-row">
                    {% include 'clubs/actions/club_actions.html' %}
                    <svg class="w-6 h-6 shrink-0 club-arrow-svg dark:group-hover:text-blue-400"
                         fill="currentColor"
                         viewBox="0 0 20 20"
                         xmlns="http://www.w3.org/2000/svg">
                      <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                  </div>
                </button>
              </h2>
              <div id="clubs-accordion-collapse-body-{{ membership.club.id|to_sqid }}"
                   class="text-gray-700 dark:text-gray-300"
                   aria-labelledby="clubs-accordion-collapse-heading-{{ membership.club.id|to_sqid }}">
                <div class="p-6 font-light border border-blue-100 dark:border-gray-700 dark:bg-gray-900">
                  <div class="flex flex-row">
                    <span class="w-48 font-bold">Total Members:</span><span class="text-sm">{{ membership.club.active_and_current_member_count|intcomma }}</span>
                  </div>
                  <div class="flex flex-row">
                    <span class="w-48 font-bold">Membership Level:</span><span class="text-sm">{{ membership.level }}</span>
                  </div>
                  <div class="flex flex-row">
                    <span class="w-48 font-bold">Join Date:</span><span class="text-sm">{{ membership.create_date|date }}</span>
                  </div>
                  <div class="flex flex-row">
                    <span class="w-48 font-bold">Mem. Expiration Date:</span><span class="text-sm">{{ membership.membership_expires|date }}</span>
                  </div>
                  {% with club_admins=membership.club.club_admins %}
                    <div class="flex flex-row">
                      <span class="w-48 font-bold">Admin{{ club_admins.count|pluralize }}:</span>
                      <span class="text-sm">
                        {% for ad in club_admins %}
                          {% if forloop.counter == 1 %}
                            {{ ad.user.name }}
                          {% else %}
                            , {{ ad.user.name }}
                          {% endif %}
                        {% endfor %}
                      </span>
                    </div>
                  {% endwith %}
                  <div class="flex flex-row">
                    {% rank_ride_count membership.club.total_rides request.user as ride_count_and_rank %}
                    <span class="w-48 font-bold">Ride Count:</span>
                    <span class="text-sm">{{ ride_count_and_rank.ride_count }} club rides completed
                      {% if ride_count_and_rank.rank != "N/A" %}- ranked #{{ ride_count_and_rank.rank }}{% endif %}
                    </span>
                  </div>
                  <div class="flex flex-row mb-1">
                    <span class="w-48 font-bold">Club Description:</span>
                  </div>
                  <span class="text-sm">{{ membership.club.description|safe }}</span>
                  {% if mem.show_registered_rides_btn or mem.show_join_rides_btn or mem.show_create_ride_btn or mem.show_manage_members_btn or mem.show_edit_club_button %}
                    <div class="flex-col mt-4 xl:w-1/8 lg:w-1/3 md:w-1/2 sm:w-2/3 w-full space-y-2">
                      {% if mem.show_registered_rides_btn %}
                        <a href="{% url 'events:available_rides' %}?club={{ membership.club.slug }}&group_classification=&distance__lt=&distance__gt="
                           class="block text-center w-full btn-primary-color">Registered Rides</a>
                      {% endif %}
                      {% if mem.show_join_rides_btn %}
                        <a href="{% url 'events:available_rides' %}?club={{ membership.club.slug }}&group_classification=&distance__lt=&distance__gt="
                           class="block text-center w-full btn-primary-color">Join Ride</a>
                      {% endif %}
                      {% if mem.show_create_ride_btn %}
                        <a href="{% url 'events:create_event' %}?club_id={{ membership.club.id|to_sqid }}"
                           class="block text-center w-full btn-primary-color">Create Ride</a>
                      {% endif %}
                      {% if mem.show_manage_members_btn %}
                        <a href="{% url 'clubs:club_member_management' slug=membership.club.slug tab_type='active' %}"
                           class="block text-center w-full btn-primary-color">Manage Members</a>
                      {% endif %}
                      {% if mem.show_edit_club_btn %}
                        <a href="{% url 'clubs:edit_club' slug=membership.club.slug %}"
                           class="block text-center w-full btn-primary-color">Edit Club</a>
                      {% endif %}
                      {% if mem.show_request_verification_btn %}
                        <button @click="requestClubVerificationModalOpen=true"
                                hx-get="{% url 'clubs:get_club_verification_form' slug=membership.club.slug %}"
                                hx-swap="outerHTML"
                                hx-target="#requestClubVerificationModalReplace"
                                class="block text-center w-full btn-primary-color">Verify Club</button>
                      {% endif %}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endwith %}
        {% endfor %}
      </div>
    </div>
  {% else %}
    <span class="font-bold text-gray-700 dark:text-gray-200">You are not a member of any clubs.
      <br />
      <br />
      <a class="underline text-blue-600 hover:text-blue-800 visited:text-purple-600"
         href="{% url 'clubs:search_club' %}">Search and join</a>
      or
      <a class="underline text-blue-600 hover:text-blue-800 visited:text-purple-600"
         href="{% url 'clubs:create_club' %}">create</a>
      your own now!
    </span>
  {% endif %}
{% endblock content %}
